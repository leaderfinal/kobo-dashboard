<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Kobo Dashboard | Calendar, Schedule and Weather Forecast</title>
    <script>
      // Global configuration - loaded from API via .env settings
      let APP_CONFIG = {};

      /**
       * Load app configuration from API
       */
      async function loadAppConfig() {
        try {
          const response = await fetch('/api/config');
          if (response.ok) {
            APP_CONFIG = await response.json();
            // Set CSS variables for responsive dimensions
            if (APP_CONFIG.screenshotWidth && APP_CONFIG.screenshotHeight) {
              document.documentElement.style.setProperty('--dashboard-width', APP_CONFIG.screenshotWidth + 'px');
              document.documentElement.style.setProperty('--dashboard-height', APP_CONFIG.screenshotHeight + 'px');
            }
          }
        } catch (error) {
          console.log('Using default timezone and weather configuration');
        }
      }

      /**
       * Get current date info for calendar rendering.
       * @returns {{year: number, month: number, monthName: string, daysInMonth: number, firstDayOfWeek: number}}
       */
      function getCurrentDateInfo() {
        // Always use the configured timezone for calendar logic
        const now = new Date(new Date().toLocaleString(APP_CONFIG.localeString, { timeZone: APP_CONFIG.timezone }));
        return {
          year: now.getFullYear(),
          month: now.getMonth(), // 0-indexed
          monthName: now.toLocaleString("default", { month: "long" }),
          daysInMonth: new Date(
            now.getFullYear(),
            now.getMonth() + 1,
            0
          ).getDate(),
          firstDayOfWeek: new Date(
            now.getFullYear(),
            now.getMonth(),
            1
          ).getDay(), // 0=Sun
        };
      }

      /**
       * Render the calendar table for the current month/year.
       */
      function renderCalendar() {
        const info = getCurrentDateInfo();
        document.querySelector(".calendar__month").textContent = info.monthName;
        document.querySelector(".calendar__year").textContent = info.year;

        const tbody = document.querySelector(".calendar__table tbody");
        tbody.innerHTML = "";
        let day = 1;
        let weeks = [];
        for (let row = 0; day <= info.daysInMonth; row++) {
          let tr = document.createElement("tr");
          for (let col = 0; col < 7; col++) {
            let td = document.createElement("td");
            td.className = "calendar__date";
            if (row === 0 && col < info.firstDayOfWeek) {
              td.textContent = "";
            } else if (day <= info.daysInMonth) {
              td.textContent = day;
              // Highlight today
              const now = new Date(new Date().toLocaleString(APP_CONFIG.localeString, { timeZone: APP_CONFIG.timezone }));
              if (
                day === now.getDate() &&
                info.month === now.getMonth() &&
                info.year === now.getFullYear()
              ) {
                td.classList.add("calendar__date--today");
              }
              day++;
            } else {
              td.textContent = "";
            }
            tr.appendChild(td);
          }
          weeks.push(tr);
        }
        weeks.forEach((tr) => tbody.appendChild(tr));
      }

      /**
       * Get emoji for weather condition code.
       * @param {string} code - Weather code from API
       * @returns {string} Emoji representing weather
       */
      function getWeatherEmoji(code) {
        // Open-Meteo uses weathercode: https://open-meteo.com/en/docs#api_form
        // Map some common codes to emoji
        const map = {
          0: "‚òÄÔ∏è", // Clear sky
          1: "üå§Ô∏è", // Mainly clear
          2: "‚õÖ", // Partly cloudy
          3: "‚òÅÔ∏è", // Overcast
          45: "üå´Ô∏è", // Fog
          48: "üå´Ô∏è", // Depositing rime fog
          51: "üå¶Ô∏è", // Drizzle: Light
          53: "üå¶Ô∏è", // Drizzle: Moderate
          55: "üå¶Ô∏è", // Drizzle: Dense
          61: "üåßÔ∏è", // Rain: Slight
          63: "üåßÔ∏è", // Rain: Moderate
          65: "üåßÔ∏è", // Rain: Heavy
          80: "üå¶Ô∏è", // Rain showers: Slight
          81: "üå¶Ô∏è", // Rain showers: Moderate
          82: "üå¶Ô∏è", // Rain showers: Violent
          95: "‚õàÔ∏è", // Thunderstorm: Slight/Moderate
          96: "‚õàÔ∏è", // Thunderstorm with hail: Slight
          99: "‚õàÔ∏è", // Thunderstorm with hail: Heavy
        };
        return map[code] || "‚ùì";
      }

      /**
       * Fetch weather data from Open-Meteo API for a given location.
       * @param {number} lat - Latitude
       * @param {number} lon - Longitude
       * @returns {Promise<Object>} Weather data
       */
      async function fetchWeather(lat, lon) {
        // Open-Meteo is free and public, no API key needed
        // Docs: https://open-meteo.com/en/docs
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&current_weather=true&timezone=auto`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Weather API error");
        return await res.json();
      }

      /**
       * Render weather section with fetched data.
       * @param {Object} weatherData - Weather API response
       */
      function renderWeather(weatherData) {
        const forecast = weatherData.daily;
        const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const today = new Date();
        const weatherForecastDiv = document.querySelector(".weather__forecast");
        weatherForecastDiv.innerHTML = "";

        for (let i = 0; i < Math.min(forecast.time.length, 5); i++) {
          const date = new Date(forecast.time[i]);
          const weekday = weekdays[date.getDay()];
          const tempMax = Math.round(forecast.temperature_2m_max[i]);
          const tempMin = Math.round(forecast.temperature_2m_min[i]);
          const code = String(forecast.weathercode[i]);
          const emoji = getWeatherEmoji(code);

          const dayDiv = document.createElement("div");
          dayDiv.className =
            "weather__forecast-day" + (i === 0 ? " current" : "");
          dayDiv.innerHTML = `
          <div class="weather__forecast-weekday">${weekday}</div>
          <div class="weather__forecast-emoji">${emoji}</div>
          <div class="weather__forecast-temp">
            <span class="weather__temp-max">${tempMax}¬∞C</span>
            <span class="weather__temp-min">${tempMin}¬∞C</span>
          </div>
        `;
          weatherForecastDiv.appendChild(dayDiv);
        }

        // Update city name if available, else use configured location
        const cityDiv = document.querySelector(".weather__city");

        if (weatherData && weatherData.timezone) {
          cityDiv.textContent = `üìç ${weatherData.timezone.replace("_", " ")}`;
        } else {
          cityDiv.textContent = `üìç ${APP_CONFIG.weather.name}`;
        }
      }

      /**
       * Get user's location using configuration.
       * @returns {Promise<{lat:number, lon:number}>}
       */
      function getUserLocation() {
        return Promise.resolve({
          lat: APP_CONFIG.weather.lat,
          lon: APP_CONFIG.weather.lon,
        });
      }

      /**
       * Initialize dashboard: calendar and weather.
       */
      async function initDashboard() {
        // Load configuration first
        await loadAppConfig();
        
        renderCalendar();

        // Set up Weather API response and rendering
        try {
          const loc = await getUserLocation();
          const weatherData = await fetchWeather(loc.lat, loc.lon);
          renderWeather(weatherData);

        } catch (e) {
          const weatherForecastDiv =
            document.querySelector(".weather__forecast");
          weatherForecastDiv.innerHTML = "<div>Weather unavailable</div>";
          const cityDiv = document.querySelector(".weather__city");
          cityDiv.textContent = APP_CONFIG.weather.name;
        }

        // Set up Calendar API response and rendering
        try {
          const calendarEvents = await loadGoogleCalendarApi();
          renderScheduleTimeline(calendarEvents);
        } catch (err) {
          const timeline = document.querySelector(".schedule__timeline");
          timeline.innerHTML =
            '<div class="schedule__event">Failed to load calendar</div>';
          console.error("Calendar load error:", err);
        }

        // Add pretty timestamp to weather__timestamp-time (once per page load)
        function updateWeatherTimestamp() {
          // Use configured timezone
          const now = new Date();
          // Get time in configured timezone
          const timezoneTime = new Date(now.toLocaleString(APP_CONFIG.localeString, { timeZone: APP_CONFIG.timezone }));
          const day = String(timezoneTime.getDate()).padStart(2, '0');
          const month = String(timezoneTime.getMonth() + 1).padStart(2, '0');
          const hour = String(timezoneTime.getHours()).padStart(2, '0');
          const minute = String(timezoneTime.getMinutes()).padStart(2, '0');
          const pretty = `${day}/${month} - ${hour}h${minute}`;
          const span = document.querySelector('.weather__timestamp-time');

          if (span) {
            span.textContent = pretty;
          }
        }

        updateWeatherTimestamp();

        /**
         * Load Google Calendar API data from API endpoint
         */
        async function loadGoogleCalendarApi() {
          const response = await fetch("/api/calendar");
          if (!response.ok) throw new Error("Failed to load calendar data");
          return await response.json();
        }

        function renderScheduleTimeline(events) {
          const timeline = document.querySelector(".schedule__timeline");
          const dateDiv = document.querySelector(".schedule__date");
          const weekdayDiv = document.querySelector(".schedule__weekday");

          // Clear any previous events
          timeline.innerHTML = "";

          const now = new Date();
          dateDiv.textContent = now.getDate();
          weekdayDiv.textContent = now.toLocaleString("default", {
            weekday: "long",
          });

          // Filter events that are today
          const todayEvents = events.filter((event) => {
            const start = event.start.dateTime || event.start.date; // all-day vs timed
            const eventDate = new Date(start);
            return eventDate.toDateString() === now.toDateString();
          });

          if (todayEvents.length === 0) {
            const emptyDiv = document.createElement("div");
            emptyDiv.className = "schedule__event";
            emptyDiv.textContent = "No meetings today";
            timeline.appendChild(emptyDiv);
            return;
          }

          todayEvents.forEach((event) => {
            const start = event.start.dateTime || event.start.date;
            const end = event.end.dateTime || event.end.date;
            const startTime = new Date(start);
            const endTime = new Date(end);
            // Format as HH:MM in configured timezone
            const startStr = startTime.toLocaleTimeString(APP_CONFIG.localeString || 'en-GB', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: false,
              timeZone: APP_CONFIG.timezone
            });
            const endStr = endTime.toLocaleTimeString(APP_CONFIG.localeString || 'en-GB', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: false,
              timeZone: APP_CONFIG.timezone
            });

            const eventDiv = document.createElement("div");
            eventDiv.className = "schedule__event";

            const timeDiv = document.createElement("div");
            timeDiv.className = "schedule__event-time";
            timeDiv.textContent = `${startStr} - ${endStr}`;

            const titleDiv = document.createElement("div");
            titleDiv.className = "schedule__event-title";
            titleDiv.textContent = event.summary || "Untitled event";

            // Add calendar source indicator
            const sourceDiv = document.createElement("div");
            sourceDiv.className = "schedule__event-source";
            if (event.calendarSource) {
              // Show a simplified version of the calendar ID
              const sourceName = event.calendarSource.includes('@') 
                ? event.calendarSource.split('@')[0] 
                : event.calendarSource;
              sourceDiv.textContent = `üìÖ ${sourceName}`;
            }

            eventDiv.appendChild(timeDiv);
            eventDiv.appendChild(titleDiv);
            if (event.calendarSource) {
              eventDiv.appendChild(sourceDiv);
            }
            timeline.appendChild(eventDiv);
          });
        }
      }

      document.addEventListener("DOMContentLoaded", initDashboard);
    </script>

    <style>
      @font-face {
        font-family: "Montserrat";
        src: url("./Montserrat-Variable.ttf") format("truetype");
        font-weight: 100 900; /* covers the full variable range */
        font-style: normal;
      }

      *,
      html > *,
      body > * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Montserrat";
        font-size: var(--dashboard-font-size, 33px);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: white;
        border: solid 1px black;
        width: var(--dashboard-width, 1680px);
        height: var(--dashboard-height, 1264px);
      }

      .dashboard {
        display: grid;
        grid-template-columns: 40% 60%;
        grid-template-rows: 100%;
        width: 100%;
        height: 100%;
      }

      .schedule {
        display: grid;
        grid-template-rows: auto 1fr;
        height: 100%;
        background-color: #ed6591;
      }

      .schedule__event {
        background: white;
        margin: 10px 30px;
        padding: 20px;
        border-radius: 16px;
        position: relative;
      }

      .schedule__event-time {
        font-weight: 700;
        margin-bottom: 20px;
      }

      .schedule__event-source {
        font-size: 24px;
        color: #666;
        margin-top: 10px;
        font-style: italic;
        position: absolute;
        right: 15px;
        top: 0;
      }

      .schedule__day {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 30px 0;
      }

      .schedule__date {
        font-size: 170px;
        font-weight: bold;
        text-align: center;
        line-height: 1;
      }

      .schedule__weekday {
        text-transform: uppercase;
        color: white;
        font-size: 40px;
        text-align: center;
        margin-top: 0;
        font-weight: bold;
      }

      .schedule__timeline {
        display: flex;
        flex-direction: column;
        gap: 0px;
        grid-row: 2;
        margin-top: 60px;
      }

      .weather__current {
        font-weight: bold;
      }

      .weather__forecast {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
      }

      .weather__title {
        margin: 30px 0;
      }

      .weather__forecast-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .weather__forecast-emoji {
        font-size: 120px;
      }

      .weather__forecast-temp {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .weather__temp-max {
        font-size: 40px;
        font-weight: bold;
        color: #ed6591;
      }
      .weather__temp-min {
        font-size: 36px;
        color: #525252;
        font-weight: normal;
      }

      .weather__city {
        margin-top: 30px;
      }

      .weather__timestamp {
        margin-top: 30px;
        font-size: 25px;
      }

      .calendar-container {
        padding: 50px;
      }

      .calendar {
        display: flex;
        flex-direction: column;
        margin-bottom: 80px;
      }

      .calendar__weekday {
        padding: 0 15px;
      }

      .calendar__title {
        display: flex;
        gap: 30px;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
      }

      .calendar__date {
        padding: 15px;
      }

      .calendar__date--today {
        background: #ed6591;
        color: white;
        font-weight: bold;
        border-radius: 8px;
      }

      .dashboard__timestamp {
        position: absolute;
        bottom: 20px;
        right: 20px;
        font-size: 24px;
        color: #666;
        font-weight: normal;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div class="schedule">
        <!-- Placeholder for Date -->
        <div class="schedule__day">
          <div class="schedule__date">25</div>
          <div class="schedule__weekday">Tuesday</div>
        </div>

        <!-- Placeholder for calendar events -->
        <div class="schedule__timeline">
          <div class="schedule__event">
            <div class="schedule__event-time">08:00 - 09:00</div>
            <div class="schedule__event-title">Morning Meeting</div>
          </div>
        </div>
      </div>

      <div class="calendar-container">
        <!-- Placeholder for calendar -->
        <div class="calendar">
          <div class="calendar__title">
            <h2 class="calendar__month">August</h2>
            <h2>|</h2>
            <h2 class="calendar__year">2025</h2>
          </div>
          <table class="calendar__table">
            <thead>
              <tr>
                <th class="calendar__weekday">Sun</th>
                <th class="calendar__weekday">Mon</th>
                <th class="calendar__weekday">Tue</th>
                <th class="calendar__weekday">Wed</th>
                <th class="calendar__weekday">Thu</th>
                <th class="calendar__weekday">Fri</th>
                <th class="calendar__weekday">Sat</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="calendar__date">1</td>
                <td class="calendar__date">2</td>
                <td class="calendar__date">3</td>
                <td class="calendar__date">4</td>
                <td class="calendar__date">5</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Placeholder for weather -->
        <div class="weather">
          <h3 class="weather__title">Weather forecast</h3>

          <div class="weather__forecast">
            <div class="weather__forecast-day current">
              <div class="weather__forecast-weekday">Mon</div>
              <div class="weather__forecast-temp">20¬∞C / 12¬∞C</div>
            </div>
          </div>

          <!-- Placeholder for city and country code -->
          <div class="weather__city">City, CC</div>

          <div class="weather__timestamp">
            Last updated at:
            <span class="weather__timestamp-time"></span>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>